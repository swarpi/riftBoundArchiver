<ng-container *ngIf="player$ | async as player; else notFound">
  <a class="back-link" [routerLink]="['/players', player.id]">
    &larr; Back to {{ player.displayName }}
  </a>

  <div class="title-bar">
    <div>
      <p class="mode-indicator editing">Managing missing cards</p>
      <h2 class="title">Missing cards for {{ player.displayName }}</h2>
      <p class="title-description">
        Keep this list accurate so the group knows what to trade or bring.
      </p>
    </div>
  </div>

  <section class="panel search-panel" [class.collapsed]="compactSearchPanel">
    <header class="search-panel-header">
      <div>
        <h3>Search card database</h3>
        <p class="description">
          Use filters to find cards you still need, then add copies.
        </p>
      </div>
      <button type="button" class="filter-toggle alt" (click)="toggleCompactSearchPanel()">
        {{ compactSearchPanel ? 'Expand' : 'Collapse' }}
      </button>
    </header>
    <app-card-search-panel
      *ngIf="!compactSearchPanel"
      title="Search card database"
      description="Use filters to find cards you still need, then add copies."
      [selectedCards]="player.missingCards"
      (addCard)="addCard(player.id, $event)"
    />
  </section>

  <div class="manager-grid">
    <section class="panel">
      <div class="panel-header">
        <h3>Missing list</h3>
        <div class="panel-actions">
          <span class="panel-meta">Total cards: {{ totalCards(player.missingCards) }}</span>
          <button type="button" class="view-toggle" (click)="toggleCardView()">
            <span class="desktop-label">
              {{ showCardImages ? 'Show names' : 'Show images' }}
            </span>
            <span class="mobile-label">
              {{ showCardImages ? 'Names' : 'Images' }}
            </span>
          </button>
          <div class="image-size-controls" *ngIf="showCardImages">
            <span>Grid</span>
            <div class="size-options">
              <button
                type="button"
                *ngFor="let option of IMAGE_COLUMN_OPTIONS"
                [class.active]="imageColumns === option"
                (click)="setImageColumns(option)"
              >
                {{ option }}
              </button>
            </div>
          </div>
        </div>
      </div>
      <ng-container *ngIf="player.missingCards.length; else emptyList">
        <ng-container
          *ngFor="let section of categorizeCards(player.missingCards); trackBy: trackByCategory"
        >
          <h4 class="category-chip">{{ section.label }}</h4>
          <ul
            [ngClass]="{
              'image-grid': showCardImages,
              'grid-cols-2': showCardImages && imageColumns === 2,
              'grid-cols-3': showCardImages && imageColumns === 3,
              'grid-cols-4': showCardImages && imageColumns === 4,
              'grid-cols-5': showCardImages && imageColumns === 5
            }"
          >
            <li
              *ngFor="let card of section.entries; trackBy: trackByCardName"
              [class.image-view]="showCardImages"
            >
              <div class="card-entry" *ngIf="!showCardImages">
                <span class="card-name">{{ card.name }}</span>
                <span class="card-count">x{{ card.count }}</span>
              </div>
              <div class="card-preview" *ngIf="showCardImages">
                <ng-container *ngIf="getCardImage(card.name) as cardImage; else missingFallback">
                  <img
                    class="card-thumb"
                    [src]="cardImage"
                    [alt]="card.name"
                    loading="lazy"
                    [appCardPreview]="{ title: card.name, imageUrl: cardImage }"
                  />
                </ng-container>
                <ng-template #missingFallback>
                  <span class="card-name placeholder">{{ card.name }}</span>
                </ng-template>
                <span class="card-count">x{{ card.count }}</span>
              </div>
              <div class="card-entry-actions">
                <div class="action-buttons">
                  <button type="button" (click)="decrementCard(player.id, card.name)">
                    -
                  </button>
                  <button type="button" (click)="addCard(player.id, card.name)">
                    +
                  </button>
                </div>
                <button type="button" class="link" (click)="removeCard(player.id, card.name)">
                  Remove
                </button>
              </div>
            </li>
          </ul>
        </ng-container>
      </ng-container>
    </section>
  </div>
</ng-container>

<ng-template #emptyList>
  <p class="placeholder">No cards are missing right now.</p>
</ng-template>

<ng-template #notFound>
  <a class="back-link" routerLink="/">&larr; Back to main menu</a>
  <div class="panel warning">
    <h3>Player not found</h3>
    <p>We could not locate that profile. Please return to the main menu.</p>
  </div>
</ng-template>
