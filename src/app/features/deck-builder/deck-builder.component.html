<ng-container *ngIf="player$ | async as player; else notFound">
  <ng-container *ngIf="deck$ | async as deck; else deckMissing">
    <ng-container *ngIf="workingDeck as working; else loadingDeck">
      <a class="back-link" [routerLink]="['/players', player.id]">
        &larr; Back to {{ player.displayName }}
      </a>

      <div class="title-bar">
        <div>
          <p class="mode-indicator" [class.editing]="isEditing">
            {{ isEditing ? 'Editing deck' : 'Viewing deck' }}
          </p>
          <h2 class="title">Deck builder for {{ renameDraft || 'Untitled Deck' }}</h2>
        </div>
        <div class="title-actions">
          <span class="dirty-indicator" *ngIf="dirty">Unsaved changes</span>
          <button type="button" class="edit-toggle" (click)="toggleEditing()">
            <span class="desktop-label">{{ isEditing ? 'Done editing' : 'Edit deck' }}</span>
            <span class="mobile-label">{{ isEditing ? 'Done' : 'Edit' }}</span>
          </button>
        </div>
      </div>

      <section class="panel search-panel" *ngIf="isEditing" [class.collapsed]="compactSearchPanel">
        <header class="search-panel-header">
          <div>
            <h3>Search card database</h3>
            <p class="description">Use filters to find cards and add them to this deck.</p>
          </div>
          <button type="button" class="filter-toggle alt" (click)="toggleCompactSearchPanel()">
            {{ compactSearchPanel ? 'Expand' : 'Collapse' }}
          </button>
        </header>
        <app-card-search-panel
          *ngIf="!compactSearchPanel"
          title="Search card database"
          description="Use filters to find cards and add them to this deck."
          [selectedCards]="working.cards"
          [maxCopies]="MAX_COPIES"
          (addCard)="addCard($event)"
        />
      </section>

      <div class="manager-grid">
        <section class="panel">
          <div class="panel-header">
            <h3>Deck list</h3>
            <div class="panel-actions">
              <span class="panel-meta">Total cards: {{ totalCards(working.cards) }}</span>
              <button type="button" class="view-toggle" (click)="toggleCardView()">
                <span class="desktop-label">
                  {{ showCardImages ? 'Show names' : 'Show images' }}
                </span>
                <span class="mobile-label">
                  {{ showCardImages ? 'Names' : 'Images' }}
                </span>
              </button>
              <div class="image-size-controls" *ngIf="showCardImages">
                <span>Grid</span>
                <div class="size-options">
                  <button
                    type="button"
                    *ngFor="let option of IMAGE_COLUMN_OPTIONS"
                    [class.active]="imageColumns === option"
                    (click)="setImageColumns(option)"
                  >
                    {{ option }}
                  </button>
                </div>
              </div>
            </div>
          </div>
          <ng-container *ngIf="isEditing; else deckNameDisplay">
            <div class="rename-form">
              <label for="deck-name">Deck name</label>
              <div class="rename-controls">
                <input
                  id="deck-name"
                  name="deck-name"
                  type="text"
                  [ngModel]="renameDraft"
                  (ngModelChange)="onDeckNameChange($event)"
                  required
                />
                <div class="rename-actions">
                  <button type="button" class="secondary" (click)="openImport()">
                    Import list
                  </button>
                  <button type="button" [disabled]="!dirty" (click)="saveDeck(player.id, deck.id)">
                    Save deck
                  </button>
                  <button type="button" class="danger" (click)="deleteDeck(player.id, deck.id)">
                    Delete deck
                  </button>
                </div>
              </div>
            </div>
          </ng-container>
          <ng-template #deckNameDisplay>
            <div class="name-display">
              <p class="label">Deck name</p>
              <p class="value">{{ renameDraft || 'Untitled Deck' }}</p>
              <p class="muted">Click Edit deck to rename or import a new list.</p>
            </div>
          </ng-template>

          <div class="mode-banner" *ngIf="!isEditing">
            <strong>Viewing only.</strong> Start editing to adjust counts or add new cards.
          </div>

          <ng-container *ngIf="working.cards.length; else emptyDeck">
            <ng-container
              *ngFor="let section of categorizeCards(working.cards); trackBy: trackByCategory"
            >
              <h4 class="category-chip">{{ section.label }}</h4>
              <ul
                [ngClass]="{
                  'image-view': showCardImages,
                  'image-grid': showCardImages,
                  'grid-cols-2': showCardImages && imageColumns === 2,
                  'grid-cols-3': showCardImages && imageColumns === 3,
                  'grid-cols-4': showCardImages && imageColumns === 4,
                  'grid-cols-5': showCardImages && imageColumns === 5
                }"
              >
                <li
                  *ngFor="let card of section.entries; trackBy: trackByCardName"
                  [class.image-view]="showCardImages"
                >
                  <div class="card-entry" *ngIf="!showCardImages">
                    <span class="card-name">{{ card.name }}</span>
                    <span class="card-count">x{{ card.count }}</span>
                  </div>
                  <div class="card-preview" *ngIf="showCardImages">
                    <ng-container *ngIf="getCardImage(card.name) as cardImage; else nameFallback">
                      <img
                        class="card-thumb"
                        [src]="cardImage"
                        [alt]="card.name"
                        loading="lazy"
                        [appCardPreview]="{ title: card.name, imageUrl: cardImage }"
                      />
                    </ng-container>
                    <ng-template #nameFallback>
                      <span class="card-name placeholder">{{ card.name }}</span>
                    </ng-template>
                    <span class="card-count">x{{ card.count }}</span>
                  </div>
                  <div class="card-entry-actions" *ngIf="isEditing">
                    <button type="button" (click)="decrementCard(card.name)">-</button>
                    <button type="button" [disabled]="!canAdd(card.name)" (click)="addCard(card.name)">
                      +
                    </button>
                    <button type="button" class="link" (click)="removeCard(card.name)">
                      Remove
                    </button>
                  </div>
                </li>
              </ul>
            </ng-container>
          </ng-container>
          <ng-container *ngIf="working.sideboard?.length">
            <h4 class="section-title">Sideboard</h4>
            <ul
              class="sideboard-list"
              [ngClass]="{
                'image-view': showCardImages,
                'image-grid': showCardImages,
                'grid-cols-2': showCardImages && imageColumns === 2,
                'grid-cols-3': showCardImages && imageColumns === 3,
                'grid-cols-4': showCardImages && imageColumns === 4,
                'grid-cols-5': showCardImages && imageColumns === 5
              }"
            >
              <li *ngFor="let card of working.sideboard">
                <ng-container *ngIf="showCardImages; else sideboardName">
                  <div class="card-preview">
                    <ng-container *ngIf="getCardImage(card.name) as sideImage; else sideFallback">
                      <img
                        class="card-thumb"
                        [src]="sideImage"
                        [alt]="card.name"
                        loading="lazy"
                        [appCardPreview]="{ title: card.name, imageUrl: sideImage }"
                      />
                    </ng-container>
                    <ng-template #sideFallback>
                      <span class="card-name placeholder">{{ card.name }}</span>
                    </ng-template>
                    <span class="card-count">x{{ card.count }}</span>
                  </div>
                </ng-container>
                <ng-template #sideboardName>
                  <span>{{ card.name }}</span>
                  <span class="card-count">x{{ card.count }}</span>
                </ng-template>
              </li>
            </ul>
          </ng-container>
        </section>

      </div>

      <div class="import-overlay" *ngIf="showImportModal" (click)="closeImport()">
        <div class="import-modal" (click)="$event.stopPropagation()">
          <h3>Import deck list</h3>
          <textarea
            rows="10"
            placeholder="Paste deck list here"
            [(ngModel)]="importText"
          ></textarea>
          <p class="error" *ngIf="importError">{{ importError }}</p>
          <div class="modal-actions">
            <button type="button" class="secondary" (click)="closeImport()">
              Cancel
            </button>
            <button type="button" (click)="applyImport()">Import</button>
          </div>
        </div>
      </div>
    </ng-container>
  </ng-container>
</ng-container>

<ng-template #emptyDeck>
  <p class="placeholder">No cards in this deck yet.</p>
</ng-template>

<ng-template #deckMissing>
  <a class="back-link" routerLink="/">&larr; Back to main menu</a>
  <div class="panel warning">
    <h3>Deck not found</h3>
    <p>The requested deck does not exist. Please choose another deck.</p>
  </div>
</ng-template>

<ng-template #loadingDeck>
  <p class="placeholder">Loading deck...</p>
</ng-template>

<ng-template #notFound>
  <a class="back-link" routerLink="/">&larr; Back to main menu</a>
  <div class="panel warning">
    <h3>Player not found</h3>
    <p>We could not locate that profile. Please return to the main menu.</p>
  </div>
</ng-template>
